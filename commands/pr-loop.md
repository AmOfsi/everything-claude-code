---
description: Run the autonomous PR review loop agent. Detects current repo/branch, spawns agent in isolated worktree, handles CI and reviews via mail.
---

# PR Loop

Run the autonomous PR review loop agent on the current repository.

## Arguments

$ARGUMENTS can be:
- `(empty)` — Use current branch and repo
- `<branch>` — Specify existing branch name

## Behavior

This command does THREE things:
1. **Safety checks** — prevent conflicts and mistakes
2. **Prepare** (quick, in main session) — branch creation + commit if needed
3. **Spawn** (background agent) — fire and forget

### Step 0: Safety Checks

```bash
REPO=$(git rev-parse --show-toplevel)
PROJECT_NAME=$(basename "$REPO")

# Check 1: Warn if another PR loop worktree exists for this repo
EXISTING_WORKTREES=$(git worktree list | grep ".worktrees" | wc -l)
if [[ "$EXISTING_WORKTREES" -gt 0 ]]; then
    echo "⚠️  WARNING: PR loop worktree already exists for this repo."
    git worktree list | grep ".worktrees"
    echo ""
    echo "Options:"
    echo "  1. Wait for existing PR to finish"
    echo "  2. Clean up stale worktree: git worktree remove <path> --force"
    echo "  3. Continue anyway (may cause conflicts)"
    # Don't block, just warn - user can decide
fi

# Check 2: Fetch latest to ensure we know remote state
git fetch origin --quiet 2>/dev/null || echo "⚠️  Could not fetch from origin (offline?)"

# Check 3: If on main, check if it's behind origin
CURRENT=$(git rev-parse --abbrev-ref HEAD)
if [[ "$CURRENT" == "main" || "$CURRENT" == "master" ]]; then
    LOCAL=$(git rev-parse HEAD)
    REMOTE=$(git rev-parse origin/$CURRENT 2>/dev/null || echo "")
    if [[ -n "$REMOTE" && "$LOCAL" != "$REMOTE" ]]; then
        BEHIND=$(git rev-list --count HEAD..origin/$CURRENT)
        if [[ "$BEHIND" -gt 0 ]]; then
            echo "ℹ️  Your $CURRENT is $BEHIND commit(s) behind origin."
            echo "   New branch will be based on your local $CURRENT."
            echo "   After PR merges, remember: git pull origin $CURRENT"
        fi
    fi
fi
```

### Step 1: Prepare (in main session)

```bash
REPO=$(git rev-parse --show-toplevel)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
```

**If on main/master with uncommitted changes:**
```bash
# 1. Create feature branch from changes
BRANCH_NAME="feat/<auto-generated-from-changes>"
git checkout -b $BRANCH_NAME
git add -A
git commit -m "feat: <auto-generated message>"
# 2. Switch user back to clean main
git checkout main
```

**If on main/master with commits ahead of origin:**
```bash
BRANCH_NAME="feat/<auto-generated>"
git branch $BRANCH_NAME
git reset --hard origin/main
# User is now on clean main, branch has the commits
```

**If already on a feature branch:**
```bash
# Nothing to do, use current branch
BRANCH_NAME=$BRANCH
```

### Step 2: Spawn agent (fire and forget)

```
Task({
  subagent_type: "pr-review-loop",
  prompt: "
    repo: <REPO>
    branch: <BRANCH_NAME>
    base: main

    CRITICAL RULES:
    1. Create a git worktree FIRST: ~/projects/.worktrees/pr-<timestamp>/
    2. NEVER touch the main working directory at <REPO>
    3. NEVER use AskUserQuestion — user is in a different session
    4. NEVER return questions or options in your output — nobody reads it
    5. When you need user input: write mail file + send notify-send
    6. Then WAIT by polling for response file (sleep 30 loop)
    7. The ONLY way to talk to the user is Ralph Mail + desktop notification
  ",
  run_in_background: true
})
```

### Step 3: Return immediately

```
PR Review Loop agent spawned in background.

Repo: <repo>
Branch: <BRANCH_NAME>
Your session: still on main (untouched)
Worktree: ~/projects/.worktrees/pr-<id>/

Check progress: tail -f <output_file>
Respond with: pr-respond <project> <pr#> --approve
```

**DO NOT** ask the user questions. Prepare the branch, spawn the agent, return.
