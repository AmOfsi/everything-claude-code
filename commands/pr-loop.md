---
description: Run the autonomous PR review loop agent. Detects current repo/branch, spawns agent in isolated worktree, handles CI and reviews via mail.
---

# PR Loop

Run the autonomous PR review loop agent on the current repository.

## Arguments

$ARGUMENTS can be:
- `(empty)` — Use current branch and repo
- `<branch>` — Specify existing branch name

## Behavior

This command does TWO things:
1. **Prepare** (quick, in main session) — branch creation + commit if needed
2. **Spawn** (background agent) — fire and forget

### Step 1: Prepare (in main session)

```bash
REPO=$(git rev-parse --show-toplevel)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
```

**If on main/master with uncommitted changes:**
```bash
# 1. Create feature branch from changes
BRANCH_NAME="feat/<auto-generated-from-changes>"
git checkout -b $BRANCH_NAME
git add -A
git commit -m "feat: <auto-generated message>"
# 2. Switch user back to clean main
git checkout main
```

**If on main/master with commits ahead of origin:**
```bash
BRANCH_NAME="feat/<auto-generated>"
git branch $BRANCH_NAME
git reset --hard origin/main
# User is now on clean main, branch has the commits
```

**If already on a feature branch:**
```bash
# Nothing to do, use current branch
BRANCH_NAME=$BRANCH
```

### Step 2: Spawn agent (fire and forget)

```
Task({
  subagent_type: "pr-review-loop",
  prompt: "
    repo: <REPO>
    branch: <BRANCH_NAME>
    base: main

    CRITICAL RULES:
    1. Create a git worktree FIRST: ~/projects/.worktrees/pr-<timestamp>/
    2. NEVER touch the main working directory at <REPO>
    3. NEVER use AskUserQuestion — user is in a different session
    4. NEVER return questions or options in your output — nobody reads it
    5. When you need user input: write mail file + send notify-send
    6. Then WAIT by polling for response file (sleep 30 loop)
    7. The ONLY way to talk to the user is Ralph Mail + desktop notification
  ",
  run_in_background: true
})
```

### Step 3: Return immediately

```
PR Review Loop agent spawned in background.

Repo: <repo>
Branch: <BRANCH_NAME>
Your session: still on main (untouched)
Worktree: ~/projects/.worktrees/pr-<id>/

Check progress: tail -f <output_file>
Respond with: pr-respond <project> <pr#> --approve
```

**DO NOT** ask the user questions. Prepare the branch, spawn the agent, return.
